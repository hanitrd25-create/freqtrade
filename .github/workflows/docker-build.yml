name: Docker Build and Deploy

on:
  workflow_call:
    secrets:
      DOCKER_PASSWORD:
        required: true
      DOCKER_USERNAME:
        required: true
      DISCORD_WEBHOOK:
        required: false
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to build Docker images for'
        required: false
        default: 'develop'
        type: string

permissions:
  contents: read

env:
  IMAGE_NAME: "freqtradeorg/freqtrade"
  CACHE_IMAGE: "freqtradeorg/freqtrade_cache"
  GHCR_IMAGE_NAME: "ghcr.io/freqtrade/freqtrade"
  PI_PLATFORM: "linux/arm/v7"

jobs:
  deploy-docker:
    name: "Deploy Docker x64 and armv7l"
    runs-on: ubuntu-22.04
    if: github.repository == 'freqtrade/freqtrade'

    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Extract branch name
      env:
        BRANCH_NAME_INPUT: ${{ github.event.inputs.branch_name }}
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          BRANCH_NAME="${BRANCH_NAME_INPUT}"
        else
          BRANCH_NAME="${GITHUB_REF##*/}"
        fi

        # Replace / with _ to create a valid tag
        TAG=$(echo "${BRANCH_NAME}" | sed -e "s/\//_/g")
        TAG_PLOT=${TAG}_plot
        TAG_FREQAI=${TAG}_freqai
        TAG_FREQAI_RL=${TAG_FREQAI}rl
        TAG_PI="${TAG}_pi"

        CACHE_TAG_PI=${CACHE_IMAGE}:${TAG_PI}_cache

        echo "GITHUB_REF='${GITHUB_REF}'"
        echo "BRANCH_NAME='${BRANCH_NAME}'"
        echo "TAG='${TAG}'"
        echo "TAG_PLOT='${TAG_PLOT}'"
        echo "TAG_FREQAI='${TAG_FREQAI}'"
        echo "TAG_FREQAI_RL='${TAG_FREQAI_RL}'"
        echo "TAG_PI='${TAG_PI}'"

        echo "BRANCH_NAME=${BRANCH_NAME}" >> "$GITHUB_ENV"
        echo "TAG=${TAG}" >> "$GITHUB_ENV"
        echo "TAG_PLOT=${TAG_PLOT}" >> "$GITHUB_ENV"
        echo "TAG_FREQAI=${TAG_FREQAI}" >> "$GITHUB_ENV"
        echo "TAG_FREQAI_RL=${TAG_FREQAI_RL}" >> "$GITHUB_ENV"
        echo "TAG_PI=${TAG_PI}" >> "$GITHUB_ENV"

        echo "CACHE_TAG_PI=${CACHE_TAG_PI}" >> "$GITHUB_ENV"

    - name: Save commit SHA to file
      # Add commit to docker container
      run: |
        echo "${GITHUB_SHA}" > freqtrade_commit

    - name: Login to Docker Hub
      uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}


    - name: Set up QEMU
      uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 #v3.11.1

    - name: Available platforms
      run: echo ${PLATFORMS}
      env:
        PLATFORMS: ${{ steps.buildx.outputs.platforms }}

    - name: Build and test and push docker images
      run: |
        build_helpers/publish_docker_multi.sh

  deploy-arm:
    name: "Deploy Docker ARM64"
    permissions:
      packages: write
    needs: [ deploy-docker ]
    # Only run on 64bit machines
    runs-on: [self-hosted, linux, ARM64]
    if: github.repository == 'freqtrade/freqtrade'

    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false

    - name: Extract branch name
      env:
        BRANCH_NAME_INPUT: ${{ github.event.inputs.branch_name }}
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          BRANCH_NAME="${BRANCH_NAME_INPUT}"
        else
          BRANCH_NAME="${GITHUB_REF##*/}"
        fi
        echo "GITHUB_REF='${GITHUB_REF}'"
        echo "BRANCH_NAME='${BRANCH_NAME}'"
        echo "BRANCH_NAME=${BRANCH_NAME}" >> "$GITHUB_ENV"

    - name: Save commit SHA to file
      # Add commit to docker container
      run: |
        echo "${GITHUB_SHA}" > freqtrade_commit

    - name: Login to Docker Hub
      uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and test and push docker images
      env:
        GHCR_USERNAME: ${{ github.actor }}
        GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        build_helpers/publish_docker_arm64.sh

    - name: Discord notification
      uses: rjstone/discord-webhook-notify@c2597273488aeda841dd1e891321952b51f7996f #v2.2.1
      if: always() && ( github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) && (github.event_name != 'schedule')
      with:
          severity: info
          details: Deploy Succeeded!
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
